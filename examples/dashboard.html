<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avi Medical Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #fafafa;
      padding: 24px;
    }
    h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    .metric-card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 20px;
    }
    .metric-label {
      font-size: 14px;
      color: #888;
      margin-bottom: 8px;
    }
    .metric-value {
      font-size: 32px;
      font-weight: 600;
    }
    .metric-value.loading {
      color: #444;
    }
    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
    }
    .chart-card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 20px;
    }
    .chart-title {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 16px;
    }
    .chart-container {
      position: relative;
      height: 300px;
    }
    .error {
      color: #e00;
      padding: 12px;
      background: #1a0a0a;
      border-radius: 8px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <h1>Avi Medical Dashboard</h1>

  <div id="error" class="error" style="display: none;"></div>

  <div class="metrics">
    <div class="metric-card">
      <div class="metric-label">Total Revenue</div>
      <div class="metric-value loading" id="total-revenue">—</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Total Cases</div>
      <div class="metric-value loading" id="total-cases">—</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Cities</div>
      <div class="metric-value loading" id="total-cities">—</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Practices</div>
      <div class="metric-value loading" id="total-practices">—</div>
    </div>
  </div>

  <div class="charts">
    <div class="chart-card">
      <div class="chart-title">Revenue by City</div>
      <div class="chart-container">
        <canvas id="revenue-by-city"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <div class="chart-title">Top 10 Practices by Revenue</div>
      <div class="chart-container">
        <canvas id="top-practices"></canvas>
      </div>
    </div>
  </div>

  <script type="module">
    // =========================================================================
    // Bonnard SDK (inline for demo - would normally import from @bonnard/sdk)
    // =========================================================================
    function createClient(config) {
      const baseUrl = config.baseUrl || 'https://app.bonnard.dev';

      async function request(endpoint, body) {
        const res = await fetch(`${baseUrl}${endpoint}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${config.apiKey}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const error = await res.json().catch(() => ({ error: res.statusText }));
          throw new Error(error.error || 'Query failed');
        }

        return res.json();
      }

      return {
        async query(options) {
          const cubeQuery = {};

          if (options.measures) {
            cubeQuery.measures = options.measures.map(m =>
              m.includes('.') ? m : `${options.cube}.${m}`
            );
          }

          if (options.dimensions) {
            cubeQuery.dimensions = options.dimensions.map(d =>
              d.includes('.') ? d : `${options.cube}.${d}`
            );
          }

          if (options.orderBy) {
            cubeQuery.order = Object.entries(options.orderBy).map(([key, dir]) => [
              key.includes('.') ? key : `${options.cube}.${key}`,
              dir,
            ]);
          }

          if (options.limit) {
            cubeQuery.limit = options.limit;
          }

          const result = await request('/api/cube/query', { query: cubeQuery });

          // Simplify keys by removing cube prefix
          const simplifiedData = result.data.map(row => {
            const simplified = {};
            for (const [key, value] of Object.entries(row)) {
              const simpleName = key.includes('.') ? key.split('.').pop() : key;
              simplified[simpleName] = value;
            }
            return simplified;
          });

          return { data: simplifiedData };
        },
      };
    }

    // =========================================================================
    // Dashboard Logic
    // =========================================================================

    const API_KEY = 'bon_pk_xsnoD_iWMMz5keM3M7aFm-WvxHGSFFDXKeS3y3bt6vo';

    const bon = createClient({
      apiKey: API_KEY,
      baseUrl: 'https://semantic-git-develop-bonnard.vercel.app',
    });

    function formatCurrency(value) {
      return new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR',
        maximumFractionDigits: 0,
      }).format(value);
    }

    function formatNumber(value) {
      return new Intl.NumberFormat('de-DE').format(value);
    }

    function showError(message) {
      const el = document.getElementById('error');
      el.textContent = message;
      el.style.display = 'block';
    }

    async function loadMetrics() {
      try {
        // Total revenue and cases
        const totals = await bon.query({
          cube: 'practice_revenue',
          measures: ['revenue_actual', 'cases_actual'],
        });

        if (totals.data.length > 0) {
          document.getElementById('total-revenue').textContent =
            formatCurrency(totals.data[0].revenue_actual);
          document.getElementById('total-revenue').classList.remove('loading');

          document.getElementById('total-cases').textContent =
            formatNumber(totals.data[0].cases_actual);
          document.getElementById('total-cases').classList.remove('loading');
        }

        // Count cities
        const cities = await bon.query({
          cube: 'practice_revenue',
          dimensions: ['city'],
        });
        document.getElementById('total-cities').textContent = cities.data.length;
        document.getElementById('total-cities').classList.remove('loading');

        // Count practices
        const practices = await bon.query({
          cube: 'practice_performance',
          dimensions: ['practice_name'],
        });
        document.getElementById('total-practices').textContent = practices.data.length;
        document.getElementById('total-practices').classList.remove('loading');

      } catch (err) {
        showError(`Failed to load metrics: ${err.message}`);
      }
    }

    async function loadRevenueByCity() {
      try {
        const result = await bon.query({
          cube: 'practice_revenue',
          measures: ['revenue_actual'],
          dimensions: ['city'],
          orderBy: { revenue_actual: 'desc' },
        });

        const ctx = document.getElementById('revenue-by-city').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: result.data.map(d => d.city),
            datasets: [{
              label: 'Revenue',
              data: result.data.map(d => d.revenue_actual),
              backgroundColor: '#3b82f6',
              borderRadius: 4,
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                ticks: {
                  color: '#888',
                  callback: (value) => formatCurrency(value),
                },
                grid: { color: '#333' },
              },
              y: {
                ticks: { color: '#888' },
                grid: { display: false },
              },
            },
          },
        });
      } catch (err) {
        showError(`Failed to load revenue by city: ${err.message}`);
      }
    }

    async function loadTopPractices() {
      try {
        const result = await bon.query({
          cube: 'practice_performance',
          measures: ['revenue_actual', 'cases_actual'],
          dimensions: ['practice_name'],
          orderBy: { revenue_actual: 'desc' },
          limit: 10,
        });

        const ctx = document.getElementById('top-practices').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: result.data.map(d => d.practice_name),
            datasets: [
              {
                label: 'Revenue',
                data: result.data.map(d => d.revenue_actual),
                backgroundColor: '#3b82f6',
                borderRadius: 4,
                yAxisID: 'y',
              },
              {
                label: 'Cases',
                data: result.data.map(d => d.cases_actual),
                backgroundColor: '#22c55e',
                borderRadius: 4,
                yAxisID: 'y1',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: '#888' },
              },
            },
            scales: {
              x: {
                ticks: { color: '#888', maxRotation: 45 },
                grid: { display: false },
              },
              y: {
                type: 'linear',
                position: 'left',
                ticks: {
                  color: '#3b82f6',
                  callback: (value) => formatCurrency(value),
                },
                grid: { color: '#333' },
              },
              y1: {
                type: 'linear',
                position: 'right',
                ticks: { color: '#22c55e' },
                grid: { display: false },
              },
            },
          },
        });
      } catch (err) {
        showError(`Failed to load top practices: ${err.message}`);
      }
    }

    // Load all data
    Promise.all([
      loadMetrics(),
      loadRevenueByCity(),
      loadTopPractices(),
    ]);
  </script>
</body>
</html>
